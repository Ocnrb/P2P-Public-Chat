<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Enforces HTTPS and sets a robust Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://unpkg.com https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    media-src 'self' blob:;
    worker-src 'self' blob: https://cdn.jsdelivr.net;
    connect-src 'self' https: wss: data:;
    frame-src https://jimmywarting.github.io;
">
    <title>Public Chat</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ethers.js Library (stable version) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"
            type="application/javascript"></script>
    <!-- DOMPurify library for HTML sanitization to prevent XSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen">

<!-- Main Chat UI -->
<div id="chatUI" class="w-full flex flex-col bg-[#1b1b1b] hidden" style="height: 100vh;">
    <div class="px-4 pt-4 flex flex-col flex-1 min-h-0">
        <div class="flex flex-wrap items-center justify-between gap-x-4 mb-4">
            <h1 id="chatTitle" class="text-2xl sm:text-3xl font-bold text-white flex-shrink-0">Lobby</h1>

            <div class="flex items-center gap-x-3 sm:gap-x-4 sm:order-3">
                
                <button id="rekeyBtn" class="text-gray-400 hover:text-white transition-colors hidden" title="Request New Session Key">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5m5-11l-6 6m-4-6l6 6"></path></svg>
                </button>

                <div class="relative">
                    <div id="online-header" class="bg-[#222] rounded-lg p-1 flex justify-between items-center cursor-pointer">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-300 text-sm">Online</span>
                            <svg class="w-4 h-4 text-gray-400 transition-transform duration-200" fill="none"
                                 stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <span class="users-badge" id="usersCounter">0</span>
                    </div>
                    <div id="usersList"
                         class="user-list absolute top-full right-0 mt-1 w-48 bg-[#2a2a2a] border border-gray-700 rounded-lg p-3 z-20 hidden">
                    </div>
                </div>

                <div class="w-px h-6 bg-gray-700 hidden sm:block"></div>

                <div class="flex items-center gap-2 sm:gap-4">
                    <button id="roomsBtn" class="text-gray-400 hover:text-white transition-colors" title="Chat Rooms">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </button>
                    <button id="walletBtn" class="text-gray-400 hover:text-white transition-colors"
                            title="Connect Wallet">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                    </button>
                    <button id="nicknameBtn" class="text-gray-400 hover:text-white transition-colors"
                            title="Set Nickname">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </button>
                    <button id="aboutBtn" class="text-gray-400 hover:text-white transition-colors"
                            title="About this App">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="user-info"
                 class="items-center space-x-2 bg-[#222] rounded-lg p-1 min-w-0 w-full sm:w-auto sm:order-2 mt-1 hidden">
                <span class="text-gray-300 text-xs flex-shrink-0">Your ID:</span>
                <span id="user-id" class="font-mono text-cyan-400 text-xs truncate"></span>
            </div>
        </div>
        <div class="flex-1 mb-1 overflow-y-auto px-4 rounded-lg flex flex-col" id="messagesContainer"></div>

        <div id="replying-to-container" class="p-3 border-t border-gray-700 hidden">
            <div class="bg-[#2a2a2a] p-2 rounded-lg relative">
                <div class="border-l-2 border-cyan-400 pl-2">
                    <div id="replying-to-user" class="font-bold text-sm">Replying to...</div>
                    <div id="replying-to-text" class="text-xs text-gray-300 truncate"></div>
                </div>
                <button id="cancel-reply-btn" class="absolute top-1 right-1 text-gray-400 hover:text-white text-xl"
                        title="Cancel Reply">×
                </button>
            </div>
        </div>

        <div class="relative flex items-center px-4 py-2">
            <input type="file" id="genericFileInput" class="hidden">
            <input type="file" id="imageInputFile" accept="image/*" class="hidden">
            <input type="file" id="videoInputFile" accept="video/*" class="hidden">

            <div id="attachMenu" class="picker-menu attach-menu hidden">
                <button id="sendImageBtn">Send Image</button>
                <button id="sendVideoBtn">Send Video</button>
                <button id="sendFileBtn">Send File</button>
                <button id="goLiveBtn">Go Live</button>
                <button id="goLiveAudioBtn">Go Live (Audio)</button>
            </div>
            <div id="emojiPicker" class="picker-menu emoji-picker hidden"></div>

            <button id="attachBtn" class="input-button" title="Attach file">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L2.5 13"></path>
                </svg>
            </button>
            <button id="emojiBtn" class="input-button" title="Insert emoji">😀</button>
            <textarea id="messageInput" rows="1" placeholder="Write a message..."
                      class="flex-1 p-3 pr-16 rounded-full focus:outline-none focus:ring-2 focus:ring-cyan-400 resize-none"></textarea>
            <button id="sendBtn" class="send-button absolute right-2 top-1/2 -translate-y-1/2" title="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Streamer Room UI -->
<div id="streamerLayout" class="w-full relative bg-black hidden" style="height: 100vh;">
    <!-- Header with Back button and Viewer Count -->
    <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center bg-gradient-to-b from-black/70 to-transparent z-10">
        <button id="backToLobbyBtn" class="bg-gray-800/80 hover:bg-gray-700/80 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Back to Lobby
        </button>
        <div id="viewerCounter" class="bg-red-600/90 text-white text-sm font-semibold px-3 py-1 rounded-full flex items-center gap-2">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
               <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
               <path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.03 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
             </svg>
            <span>-</span>
        </div>
    </div>

    <!-- Video Panel (takes full space) -->
    <div id="streamViewerPanel" class="w-full h-full flex items-center justify-center overflow-hidden">
        <p class="text-gray-500">Stream offline</p>
    </div>
    
    <!-- Chat Panel (overlays on the bottom) -->
    <div id="streamerChatPanel" class="absolute bottom-0 left-0 right-0 flex flex-col max-h-[50vh] overflow-hidden transition-colors duration-300" style="background-color: rgba(27, 27, 27, 0);">
         <!-- Chat Settings Toggle -->
        <div id="chatSettingsToggle" class="text-center py-1 cursor-pointer flex justify-start items-center">
             <button class="text-gray-400 hover:text-white transition-transform duration-300 p-2">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                   <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                 </svg>
             </button>
        </div>
         <!-- Collapsible Chat Settings -->
        <div id="chatSettingsContainer" class="px-1 pb-2 hidden">
            <label for="chatOpacitySlider" class="text-xs text-gray-400">Chat Transparency</label>
            <input id="chatOpacitySlider" type="range" min="0" max="100" value="0"
                   class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer mt-1">
        </div>
        <div id="streamerChatContainer" class="flex-1 overflow-y-auto px-0 flex flex-col"></div>
         <!-- Chat input for streamer room -->
        <div class="relative flex items-center px-0 py-2 border-t border-gray-700/50">
             <textarea id="messageInputStreamer" rows="1" placeholder="Write a message..."
                       class="flex-1 p-3 pr-16 rounded-full focus:outline-none focus:ring-2 focus:ring-cyan-400 resize-none"></textarea>
             <button id="sendBtnStreamer" class="send-button absolute right-6 top-1/2 -translate-y-1/2" title="Send message">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                      stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                 </svg>
             </button>
        </div>
    </div>
</div>


<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-sm w-full text-gray-300 text-center">
        <div id="loginContent">
            <h2 class="text-2xl font-bold mb-4 text-white">Welcome to the Public Chat</h2>
            <p class="mb-6">For a persistent identity, connect your wallet. Otherwise, you can continue as a guest
                with a temporary ID.</p>
            <button id="connectWalletBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors mb-4 flex items-center justify-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
                Connect Wallet
            </button>
            <button id="guestBtn"
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                Continue as Guest
            </button>
        </div>
        <div id="loadingContent" class="hidden">
            <div class="flex justify-center items-center mb-4">
                <div class="spinner"></div>
            </div>
            <p class="text-lg">Connecting...</p>
            <p class="text-sm text-gray-400 mt-2">Please follow the instructions in your wallet.</p>
        </div>
    </div>
</div>


<!-- Other Modals -->
<div id="roomSelectionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-sm w-full text-gray-300">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Chat Rooms</h2>
            <button id="closeRoomModalBtn" class="text-gray-400 hover:text-white text-3xl" title="Close">×</button>
        </div>

        <div class="mb-6 border-b border-gray-700 pb-6">
            <p class="mb-2 text-gray-400">Create a new room</p>
            <div class="flex items-center gap-2 mb-3">
                <input type="text" id="newRoomInput"
                       class="flex-1 bg-[#2a2a2a] border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400"
                       placeholder="Enter room name...">
                <button id="createRoomBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Create
                </button>
            </div>
            
            <div class="mb-3">
                 <p class="text-sm text-gray-400 mb-2">Room Type</p>
                 <div class="flex gap-x-4">
                     <label class="flex items-center">
                         <input type="radio" name="roomType" value="chat" checked class="h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                         <span class="ml-2 text-sm text-gray-300">Chat Room</span>
                     </label>
                     <label class="flex items-center">
                         <input type="radio" name="roomType" value="streamer" class="h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                         <span class="ml-2 text-sm text-gray-300">Live Streaming Room</span>
                     </label>
                 </div>
            </div>

            <div id="securityOptionsContainer">
                <div class="flex items-center">
                    <input id="privateRoomCheckbox" type="checkbox"
                           class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-gray-700">
                    <label for="privateRoomCheckbox" class="ml-2 block text-sm text-gray-300">Private Room</label>
                    <div class="tooltip inline-block ml-1 align-middle">
                        <svg id="privateRoomInfoBtn" xmlns="http://www.w3.org/2000/svg"
                             class="h-4 w-4 text-gray-400 hover:text-white cursor-pointer" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="tooltip-text w-64">Click to learn more about Private Rooms.</span>
                    </div>
                </div>
                <div id="passwordContainer" class="mt-3 hidden">
                    <input type="password" id="roomPasswordInput"
                           class="w-full bg-[#2a2a2a] border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400"
                           placeholder="Enter room password...">
                </div>
                <div class="flex items-center mt-3">
                    <input id="pfsRoomCheckbox" type="checkbox"
                           class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-gray-700">
                    <label for="pfsRoomCheckbox" class="ml-2 block text-sm text-gray-300">High-Security (Ephemeral)
                        Mode</label>
                    <div class="tooltip inline-block ml-1 align-middle">
                        <svg id="pfsRoomInfoBtn" xmlns="http://www.w3.org/2000/svg"
                             class="h-4 w-4 text-gray-400 hover:text-white cursor-pointer" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="tooltip-text w-72">Click to learn more about High-Security (Ephemeral) Mode.</span>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <h3 class="font-bold mb-2 text-gray-400">Join a room</h3>
            <div id="roomList" class="space-y-2 max-h-48 overflow-y-auto">
            </div>
        </div>
    </div>
</div>

<div id="nicknameModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-sm w-full text-gray-300">
        <h2 class="text-2xl font-bold mb-4 text-white">Set Your Nickname</h2>
        <p class="mb-4">This will be displayed to other users in the chat.</p>
        <input type="text" id="nicknameInput"
               class="w-full bg-[#2a2a2a] border border-gray-600 rounded-lg p-2 mb-4 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400"
               placeholder="Enter your nickname...">

        <div class="flex items-center mb-4">
            <input id="ghostModeCheckbox" type="checkbox"
                   class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-gray-700">
            <label for="ghostModeCheckbox" class="ml-2 block text-sm text-gray-300">Ghost Mode</label>
        </div>
        <p class="text-xs text-gray-500 mb-4 -mt-2">When enabled, you won't appear in the online list and your typing
            status will be hidden.</p>

        <div class="flex items-center gap-4">
            <button id="saveNicknameBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                    title="Save Nickname">
                Save
            </button>
            <button id="resetNicknameBtn"
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                    title="Reset to ID">
                Reset to ID
            </button>
        </div>
    </div>
</div>

<div id="aboutModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-md w-full text-gray-300 max-h-[90vh] overflow-y-auto">
        <h2 class="text-2xl font-bold mb-4 text-white">About This Chat</h2>
        <p class="mb-4">Data is transmitted P2P in real-time via the <a href="https://docs.streamr.network/"
                                                                         target="_blank" rel="noopener noreferrer"
                                                                         class="text-blue-400 hover:underline">Streamr</a>
            pub/sub network.</p>
        <p class="mb-6">By running the application, each user becomes a node in the network, allowing it to scale
            effortlessly to thousands of simultaneous users, while ensuring secure, <span class="font-semibold">tamper-proof</span>,
            and resilient communication without relying on central servers.</p>

        <p class="mb-4">This app is highly resilient, as it can be
            hosted on countless services or even run locally from your computer. If one link goes down, another can be
            used. Here are a few examples:</p>
        <ul class="list-disc list-inside mb-6 space-y-2 text-sm">
            <li><a href="https://p2p-public-chat.vercel.app/" target="_blank" rel="noopener noreferrer"
                   class="text-blue-400 hover:underline">Hosted on Vercel</a></li>
            <li><a href="https://p2p-public-chat.netlify.app/" target="_blank" rel="noopener noreferrer"
                   class="text-blue-400 hover:underline">Hosted on Netlify</a></li>
            <li><a href="https://public-chat.edgeone.app/" target="_blank" rel="noopener noreferrer"
                   class="text-blue-400 hover:underline">Hosted on EdgeOne</a></li>
        </ul>



        <div class="bg-yellow-900 border-l-4 border-yellow-500 text-yellow-100 p-4 rounded-r-lg mt-4">
            <h3 class="font-bold">Security Warning</h3>
            <p>This is a public and unmoderated chat. Be cautious when downloading files from unknown users, as they
                may contain malicious software.</p>
        </div>

        <button id="closeModalBtn"
                class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
            Close
        </button>
    </div>
</div>


<div id="customAlertModal"
     class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-md w-full text-gray-300">
        <h2 id="customAlertTitle" class="text-2xl font-bold mb-4 text-white">Alert</h2>
        <p id="customAlertMessage" class="mb-6"></p>
        <button id="closeAlertBtn"
                class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
            OK
        </button>
    </div>
</div>

<div id="fileConfirmModal"
     class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-md w-full text-gray-300">
        <h2 class="text-2xl font-bold mb-4 text-white">Confirm File Send</h2>
        <div class="mb-6 text-left">
            <p>You are about to send the following file:</p>
            <p class="mt-2 bg-[#2a2a2a] p-3 rounded-lg">
                <strong>File:</strong> <span id="confirmFileName"></span><br>
                <strong>Size:</strong> <span id="confirmFileSize"></span>
            </p>
        </div>
        <div class="flex justify-end gap-4">
            <button id="cancelSendBtn"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Cancel
            </button>
            <button id="confirmSendBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Confirm &amp; Send
            </button>
        </div>
    </div>
</div>

<!-- Stream Quality Modal -->
<div id="streamSettingsModal"
     class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-md w-full text-gray-300">
        <h2 class="text-2xl font-bold mb-6 text-white">Stream Settings</h2>

        <div class="space-y-6">
            <div>
                <label for="resolutionSelect" class="block mb-2 text-sm font-medium text-gray-400">Resolution</label>
                <select id="resolutionSelect"
                        class="w-full bg-[#2a2a2a] border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400">
                    <option value="640x360">360p (Low)</option>
                    <option value="854x480" selected>480p (Medium)</option>
                    <option value="1280x720">720p (High)</option>
                </select>
            </div>

            <div>
                <label for="fpsSlider" class="flex justify-between mb-2 text-sm font-medium text-gray-400">
                    <span>Frame Rate (FPS)</span>
                    <span id="fpsValue">15</span>
                </label>
                <input id="fpsSlider" type="range" min="5" max="30" value="15"
                       class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
            </div>

            <div>
                <label for="qualitySlider" class="flex justify-between mb-2 text-sm font-medium text-gray-400">
                    <span>Compression Quality</span>
                    <span id="qualityValue">50%</span>
                </label>
                <input id="qualitySlider" type="range" min="10" max="100" value="50"
                       class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>

        <div class="flex justify-end gap-4 mt-8">
            <button id="cancelStreamSettingsBtn"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Cancel
            </button>
            <button id="continueToCameraBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Continue
            </button>
        </div>
    </div>
</div>


<!-- Camera Selection Modal -->
<div id="cameraSelectModal"
     class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-md w-full text-gray-300">
        <h2 class="text-2xl font-bold mb-4 text-white">Select Camera</h2>
        <div class="mb-6">
            <label for="cameraSelect" class="block mb-2 text-sm font-medium text-gray-400">Choose a video
                source:</label>
            <select id="cameraSelect"
                    class="w-full bg-[#2a2a2a] border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
        </div>
        <div class="flex justify-end gap-4">
            <button id="cancelStreamBtn"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Cancel
            </button>
            <button id="startStreamBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Start Stream
            </button>
        </div>
    </div>
</div>

<!-- ADDED: Microphone Selection Modal -->
<div id="micSelectModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-[#1e1e1e] rounded-lg p-8 max-w-md w-full text-gray-300">
        <h2 class="text-2xl font-bold mb-4 text-white">Select Microphone</h2>
        <div class="mb-6">
            <label for="micSelect" class="block mb-2 text-sm font-medium text-gray-400">Choose an audio
                source:</label>
            <select id="micSelect"
                    class="w-full bg-[#2a2a2a] border border-gray-600 rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
        </div>
        <div class="flex justify-end gap-4">
            <button id="cancelAudioStreamBtn"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Cancel
            </button>
            <button id="startAudioStreamBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                Start Audio Stream
            </button>
        </div>
    </div>
</div>


<div id="videoPreviewModal"
     class="fixed bottom-4 right-4 bg-[#1e1e1e] rounded-lg p-2 shadow-lg border border-gray-700 z-50 hidden">
    <video id="localVideoPreview" autoplay muted playsinline class="w-48 h-auto rounded-md"></video>
    <div class="mt-2">
        <label for="opacitySlider" class="text-xs text-gray-400">Transparency</label>
        <input id="opacitySlider" type="range" min="20" max="100" value="100"
               class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
    </div>
    <div class="flex gap-2 mt-2">
        <button id="toggleFlashlightBtn"
                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors hidden">
            Flashlight
        </button>
        <button id="stopVideoStreamBtn"
                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors">
            Stop
        </button>
    </div>
</div>

<div id="audioPreviewModal" class="fixed bottom-4 right-4 bg-[#1e1e1e] rounded-lg p-2 shadow-lg border border-gray-700 z-50 hidden">
    <div class="flex items-center gap-3">
         <div class="text-red-500">
            <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
         </div>
         <span class="text-white text-sm">Live Audio</span>
         <button id="stopAudioStreamBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors">Stop</button>
    </div>
</div>

<div id="reactionPickerTemplate" class="reaction-picker">
    <span data-emoji="👍">👍</span> <span data-emoji="❤️">❤️</span> <span data-emoji="😂">😂</span> <span
        data-emoji="🎉">🎉</span>
    <span data-emoji="😢">😢</span> <span data-emoji="🤔">🤔</span> <span data-emoji="🙏">🙏</span> <span
        data-emoji="🔥">🔥</span>
    <span data-emoji="😮">😮</span> <span data-emoji="👏">👏</span> <span data-emoji="🤦‍♂️">🤦‍♂️</span> <span
        data-emoji="🤬">🤬</span>
    <span data-emoji="💀">💀</span> <span data-emoji="🚀">🚀</span> <span data-emoji="👌">👌</span> <span
        data-emoji="💩">💩</span>
    <span data-emoji="🤡">🤡</span>
</div>

<!-- NOTE: For production, it's recommended to host dependencies locally or use a pinned version with an SRI hash. -->
<!-- The @latest tag for the Streamr SDK is convenient for development but not ideal for production security. -->
<script src="https://unpkg.com/@streamr/sdk@latest/dist/streamr-sdk.web.js"></script>
<script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>

<!-- Link to the external JavaScript file -->
<script type="module" src="app.js" defer></script>
</body>
</html>

